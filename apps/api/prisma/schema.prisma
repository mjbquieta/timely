generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserType {
  ADMIN
  BRANCH_OWNER
  BRANCH_ADMIN
  PAYROLL_MASTER
  BRANCH_ATTENDEE // Attendee must have their own access page
  ATTENDEE
  COMPANY_OWNER
}

enum SignatureType {
  FINGERPRINT
  FACE_RECOGNITION
  RFID
  PASSWORD
}

enum HasConsole {
  ALLOWED
  REVOKED
  DENIED
}

enum DeviceMode {
  UI_MGLOG_CLOSED
  UI_MGLOG_OPENED
  UI_MGLOG_HAND_OPEN
  UI_MGLOG_PROG_OPEN
  UI_MGLOG_PROG_CLOSE
  UI_MGLOG_ILLEGAL_OPEN
  UI_MGLOG_ILLEGAL_REMOVE
  UI_MGLOG_ALARM
  UI_MGLOG_BOOT
}

enum AttendanceStatus {
  PRESENT
  LATE
  UNDERTIME
  OVERTIME
  SICK
  VACATION
  ABSENT
  NO_WORK
}

enum PortalType {
  BRANCH_PORTAL
  ADMIN_PORTAL
  ATTENDEE_PORTAL
  COMPANY_PORTAL
}

enum HolidayType {
  REGULAR_HOLIDAY
  SPECIAL_NON_WORKING_HOLIDAY
  COMPANY_HOLIDAY
}

enum RestDayScheduleType {
  FIXED_WEEKLY
  ROTATING
}

enum PayrollCutoffStatus {
  DRAFT
  ACTIVE
  LOCKED
  RELEASED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOCK
  UNLOCK
  OVERRIDE
}

enum EntityType {
  HOLIDAY
  REST_DAY_RULE
  PAYROLL_CUTOFF
}

model Company {
  id       String  @id @default(uuid())
  name     String
  address1 String? @map("address_1")
  address2 String? @map("address_2")
  city     String? @map("city")
  state    String? @map("state")
  zip      String? @map("zip")
  country  String? @map("country")
  phone    String? @map("phone")
  ownerId  String  @map("owner_id")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  branches Branch[]
  owner    User?    @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@map("company")
}

model Branch {
  id                 String    @id @default(uuid())
  name               String
  address1           String?   @map("address_1")
  address2           String?   @map("address_2")
  city               String?   @map("city")
  state              String?   @map("state")
  zip                String?   @map("zip")
  country            String?   @map("country")
  phone              String?   @map("phone")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  deletedAt          DateTime? @map("deleted_at")
  timezone           String?   @default("Asia/Manila") @map("timezone")
  deviceSerialNumber String?   @unique @map("device_serial_no")
  companyId          String?   @map("company_id")

  // Relations
  users          User[]
  attendances    Attendance[]
  departments    Department[]
  shifts         Shift[]
  company        Company?        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  holidays       Holiday[]
  restDayRules   RestDayRule[]
  payrollCutoffs PayrollCutoff[]

  @@map("branches")
}

model User {
  id              String     @id @default(uuid())
  type            UserType[] @default([ATTENDEE])
  branchId        String?    @map("branch_id")
  deviceEnrollId  Int?       @unique @map("device_enroll_id")
  deviceIsAdmin   Boolean    @default(false) @map("device_is_admin")
  deviceFpfFlag   Boolean    @default(false) @map("device_fpf_flag")
  deviceIsEnabled Boolean    @default(true) @map("device_is_enabled")
  deviceShiftId   Int?       @map("device_shift_id")
  departmentId    String?    @map("department_id")
  hasConsole      HasConsole @default(DENIED) @map("has_console")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  branch                 Branch?                @relation(fields: [branchId], references: [id])
  profile                UserProfile?
  attendances            Attendance[]
  accessTokens           AccessToken[]
  signatures             UserSignature[]
  department             Department?            @relation(fields: [departmentId], references: [id])
  userNonWorkingStatus   UserNonWorkingStatus[]
  companies              Company[]
  auditLogs              AuditLog[]
  createdHolidays        Holiday[]              @relation("HolidayCreator")
  restDayRules           RestDayRule[]          @relation("UserRestDayRule")
  createdRestDayRules    RestDayRule[]          @relation("RestDayCreator")
  createdPayrollCutoffs  PayrollCutoff[]        @relation("PayrollCutoffCreator")
  lockedPayrollCutoffs   PayrollCutoff[]        @relation("PayrollCutoffLocker")

  @@map("users")
}

model UserProfile {
  id       String  @id @default(uuid())
  username String? @unique
  email    String? @unique
  name     String? @map("name")
  address1 String? @map("address_1")
  address2 String? @map("address_2")
  city     String? @map("city")
  state    String? @map("state")
  zip      String? @map("zip")
  country  String? @map("country")
  phone    String? @map("phone")
  password String? @map("password")

  userId String @unique @map("user_id")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model UserNonWorkingStatus {
  id       String           @id @default(uuid())
  userId   String           @map("user_id")
  date     String           @map("date")
  timezone String           @map("timezone")
  status   AttendanceStatus @default(ABSENT)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_non_working_statuses")
}

model Department {
  id          String    @id @default(uuid())
  branchId    String    @map("branch_id")
  name        String
  description String?   @map("description")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  shiftId     String?   @map("shift_id")

  // Relations
  branch       Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  users        User[]
  shift        Shift?        @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  restDayRules RestDayRule[]

  @@map("departments")
}

model Shift {
  id          String    @id @default(uuid())
  name        String
  description String?   @map("description")
  isDefault   Boolean   @default(false) @map("is_default")
  startTime   String    @map("start_time")
  endTime     String    @map("end_time")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  branchId String? @map("branch_id")

  // Relations
  branch      Branch?      @relation(fields: [branchId], references: [id], onDelete: Cascade)
  departments Department[]

  @@map("shifts")
}

model UserSignature {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  deviceEnrollId  Int?          @map("device_enroll_id")
  deviceBackupNum Int?          @map("device_backup_num")
  deviceSignature String?       @map("device_signature")
  type            SignatureType @default(FINGERPRINT)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_signatures")
}

model Attendance {
  id              String           @id @default(uuid())
  userId          String           @map("user_id")
  branchId        String           @map("branch_id")
  time            DateTime         @map("time")
  isTimeIn        Boolean          @default(true) @map("is_time_in")
  deviceMode      DeviceMode       @default(UI_MGLOG_HAND_OPEN) @map("device_mode")
  status          AttendanceStatus @default(PRESENT)
  remarks         String?          @map("remarks")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  deletedAt       DateTime?        @map("deleted_at")
  timezone        String           @default("Asia/Manila") @map("timezone")
  departmentName  String?          @map("department_name")
  startTime       String?          @map("start_time")
  endTime         String?          @map("end_time")
  payrollCutoffId String?          @map("payroll_cutoff_id")

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch        Branch         @relation(fields: [branchId], references: [id], onDelete: Cascade)
  payrollCutoff PayrollCutoff? @relation(fields: [payrollCutoffId], references: [id])

  @@map("attendances")
}

model AccessToken {
  id           String     @id @default(uuid())
  userId       String     @map("user_id")
  accessToken  String     @unique @map("access_token")
  refreshToken String     @unique @map("refresh_token")
  portalType   PortalType @default(ATTENDEE_PORTAL) @map("portal_type")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  expiresAt DateTime? @map("expires_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("access_tokens")
}

model AuditLog {
  id             String      @id @default(uuid())
  entityType     EntityType  @map("entity_type")
  entityId       String      @map("entity_id")
  action         AuditAction
  performedBy    String      @map("performed_by")
  performedAt    DateTime    @default(now()) @map("performed_at")
  beforeSnapshot Json?       @map("before_snapshot")
  afterSnapshot  Json?       @map("after_snapshot")
  reason         String?

  // Relations
  performer User @relation(fields: [performedBy], references: [id])

  @@index([entityType, entityId])
  @@index([performedBy])
  @@index([performedAt])
  @@map("audit_logs")
}

model Holiday {
  id                 String      @id @default(uuid())
  branchId           String      @map("branch_id")
  name               String
  type               HolidayType
  startDate          String      @map("start_date")
  endDate            String?     @map("end_date")
  isPaid             Boolean     @default(true) @map("is_paid")
  notes              String?

  // Versioning (SCD Type 2)
  version            Int         @default(1)
  effectiveStartDate DateTime    @map("effective_start_date")
  effectiveEndDate   DateTime?   @map("effective_end_date")
  isCurrentVersion   Boolean     @default(true) @map("is_current_version")
  previousVersionId  String?     @map("previous_version_id")
  isUsedInPayroll    Boolean     @default(false) @map("is_used_in_payroll")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String    @map("created_by")

  // Relations
  branch          Branch    @relation(fields: [branchId], references: [id], onDelete: Cascade)
  previousVersion Holiday?  @relation("HolidayVersions", fields: [previousVersionId], references: [id])
  nextVersions    Holiday[] @relation("HolidayVersions")
  creator         User      @relation("HolidayCreator", fields: [createdBy], references: [id])

  @@index([branchId, isCurrentVersion])
  @@index([startDate, endDate])
  @@map("holidays")
}

model RestDayRule {
  id               String              @id @default(uuid())
  name             String
  scheduleType     RestDayScheduleType @map("schedule_type")

  // FIXED_WEEKLY: [0,6] = Sun, Sat
  fixedDays        Int[]               @map("fixed_days")

  // ROTATING: 4-on/1-off pattern
  workDays         Int?                @map("work_days")
  restDays         Int?                @map("rest_days")
  patternStartDate String?             @map("pattern_start_date")

  // Scope (priority: user > department > branch)
  branchId         String?             @map("branch_id")
  departmentId     String?             @map("department_id")
  userId           String?             @map("user_id")

  // Effective dating
  effectiveFrom    DateTime            @map("effective_from")
  effectiveTo      DateTime?           @map("effective_to")

  // Versioning
  version           Int      @default(1)
  previousVersionId String?  @map("previous_version_id")
  isCurrentVersion  Boolean  @default(true) @map("is_current_version")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String    @map("created_by")

  // Relations
  branch          Branch?       @relation(fields: [branchId], references: [id], onDelete: Cascade)
  department      Department?   @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  user            User?         @relation("UserRestDayRule", fields: [userId], references: [id], onDelete: Cascade)
  previousVersion RestDayRule?  @relation("RestDayVersions", fields: [previousVersionId], references: [id])
  nextVersions    RestDayRule[] @relation("RestDayVersions")
  creator         User          @relation("RestDayCreator", fields: [createdBy], references: [id])

  @@index([branchId, isCurrentVersion])
  @@index([userId, isCurrentVersion])
  @@index([departmentId, isCurrentVersion])
  @@index([effectiveFrom, effectiveTo])
  @@map("rest_day_rules")
}

model PayrollCutoff {
  id                 String              @id @default(uuid())
  branchId           String              @map("branch_id")
  name               String

  periodStartDate    DateTime            @map("period_start_date")
  periodStartTime    String              @map("period_start_time")
  periodEndDate      DateTime            @map("period_end_date")
  periodEndTime      String              @map("period_end_time")

  releaseDate        DateTime?           @map("release_date")
  status             PayrollCutoffStatus @default(DRAFT)

  lockedAt           DateTime?           @map("locked_at")
  lockedBy           String?             @map("locked_by")
  lastOverrideAt     DateTime?           @map("last_override_at")
  lastOverrideBy     String?             @map("last_override_by")
  lastOverrideReason String?             @map("last_override_reason")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String    @map("created_by")

  // Relations
  branch      Branch       @relation(fields: [branchId], references: [id], onDelete: Cascade)
  creator     User         @relation("PayrollCutoffCreator", fields: [createdBy], references: [id])
  locker      User?        @relation("PayrollCutoffLocker", fields: [lockedBy], references: [id])
  attendances Attendance[]

  @@index([branchId, status])
  @@index([periodStartDate, periodEndDate])
  @@map("payroll_cutoffs")
}
